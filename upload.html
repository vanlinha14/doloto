<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Upload ·∫£nh v√© - D√≤ L√¥ T√¥</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page-header {
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .btn-back {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
        }
        .page-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .ticket-type-badge {
            margin-left: auto;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        .page-content {
            flex: 1;
            padding: 16px;
        }
        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--background);
            margin-bottom: 16px;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(255,107,0,0.05);
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }
        #uploaded-image {
            width: 100%;
            max-height: 40vh;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        .ocr-btn {
            width: 100%;
            background-color: #673AB7 !important;
            margin-bottom: 12px;
            padding: 14px;
        }
        .save-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-bottom: 20px;
        }
        .save-actions button {
            flex: 1;
            padding: 14px;
        }
        .ticket-grid {
            margin: 16px 0;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 0.875rem;
        }
        .column-ranges {
            margin: 12px 0;
            padding: 12px;
            background: var(--background);
            border-radius: 8px;
            font-size: 0.75rem;
        }
        .ranges-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .ranges-row span {
            background: white;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        .quick-numbers-section {
            margin-top: 12px;
            padding: 12px;
            background: var(--background);
            border-radius: 8px;
        }
        .quick-numbers-section .helper-hint {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        .quick-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .quick-number-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,107,0,0.1);
            color: var(--primary);
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
        }
        .quick-number-btn:hover, .quick-number-btn:active {
            background: var(--primary);
            color: white;
        }
        .quick-numbers-5x5 {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .quick-numbers-5x5 .quick-number-btn {
            width: auto;
            height: 32px;
            font-size: 0.8rem;
        }
        .bulk-input-section {
            margin-bottom: 12px;
        }
        .bulk-input-container {
            background: var(--background);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
        }
        #bulk-input-text {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 8px;
        }
        #bulk-input-text:focus {
            border-color: var(--primary);
            outline: none;
        }
        .bulk-input-actions {
            display: flex;
            gap: 8px;
        }
        .bulk-input-actions button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <button class="btn-back" onclick="goBack()">‚Üê</button>
            <h1>Upload ·∫£nh v√©</h1>
            <span id="ticket-type-badge" class="ticket-type-badge"></span>
        </header>

        <div class="page-content">
            <!-- Upload Section -->
            <div id="upload-section">
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">üì§</div>
                    <p>Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y</p>
                    <p class="hint">H·ªó tr·ª£: JPG, PNG, GIF</p>
                </div>
                <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
            </div>

            <!-- Review Section -->
            <div id="review-section" style="display: none;">
                <img id="uploaded-image" alt="·∫¢nh ƒë√£ upload">

                <!-- OCR button - ch·ªâ hi·ªán cho v√© classic -->
                <button id="ocr-btn" class="btn-primary ocr-btn" onclick="runOCR()">
                    ‚ú® Nh·∫≠n di·ªán s·ªë t·ª± ƒë·ªông (OCR)
                </button>

                <div id="status-message" class="status-message" style="display: none;"></div>

                <div class="form-group">
                    <label for="ticket-name">T√™n v√©</label>
                    <input type="text" id="ticket-name" placeholder="Nh·∫≠p t√™n v√©">
                </div>

                <!-- Hint -->
                <p id="grid-hint" class="hint">Nh·∫•n v√†o √¥ ƒë·ªÉ nh·∫≠p s·ªë tr·ª±c ti·∫øp. M·ªói h√†ng ph·∫£i c√≥ ƒë√∫ng 5 s·ªë.</p>

                <!-- Nh·∫≠p h√†ng lo·∫°t -->
                <div class="bulk-input-section">
                    <button class="btn-secondary btn-small" onclick="toggleBulkInput()" id="bulk-input-toggle">
                        üìù Nh·∫≠p h√†ng lo·∫°t
                    </button>
                    <div id="bulk-input-container" class="bulk-input-container" style="display: none;">
                        <textarea id="bulk-input-text" placeholder="Nh·∫≠p s·ªë theo d√≤ng, m·ªói d√≤ng l√† 1 h√†ng
V√≠ d·ª•: 1 2 3 4 5 ho·∫∑c 6,7,8,9,10"></textarea>
                        <div class="bulk-input-actions">
                            <button class="btn-secondary btn-small" onclick="clearBulkInput()">X√≥a</button>
                            <button class="btn-primary btn-small" onclick="applyBulkInput()">√Åp d·ª•ng</button>
                        </div>
                    </div>
                </div>

                <!-- Grid cho v√© classic -->
                <div id="classic-grid-section">
                    <div id="ticket-grid-classic" class="ticket-grid editable"></div>

                    <div class="column-ranges">
                        <p><strong>Ph·∫°m vi s·ªë theo c·ªôt:</strong></p>
                        <div class="ranges-row">
                            <span>C1: 1-9</span>
                            <span>C2: 10-19</span>
                            <span>C3: 20-29</span>
                            <span>C4: 30-39</span>
                            <span>C5: 40-49</span>
                            <span>C6: 50-59</span>
                            <span>C7: 60-69</span>
                            <span>C8: 70-79</span>
                            <span>C9: 80-90</span>
                        </div>
                    </div>

                    <!-- Quick numbers section -->
                    <div id="quick-numbers-section" class="quick-numbers-section" style="display: none;">
                        <p class="helper-hint">Ch·ªçn nhanh:</p>
                        <div id="quick-numbers" class="quick-numbers"></div>
                    </div>
                </div>

                <!-- Grid cho v√© 5x5 -->
                <div id="5x5-grid-section" style="display: none;">
                    <div id="ticket-grid-5x5" class="ticket-grid ticket-grid-5x5 editable"></div>

                    <div class="column-ranges">
                        <p><strong>L∆∞u √Ω:</strong> V√© 5x5 g·ªìm 2 khung, m·ªói khung 5x5. √î gi·ªØa (‚òÖ) kh√¥ng nh·∫≠p s·ªë. S·ªë kh√¥ng tr√πng trong c√πng 1 khung.</p>
                    </div>

                    <!-- Quick numbers section cho 5x5 -->
                    <div id="quick-numbers-section-5x5" class="quick-numbers-section" style="display: none;">
                        <p class="helper-hint">Ch·ªçn nhanh (1-90):</p>
                        <div id="quick-numbers-5x5" class="quick-numbers quick-numbers-5x5"></div>
                    </div>
                </div>

                <div class="save-actions">
                    <button class="btn-secondary" onclick="resetUpload()">üîÑ Ch·ªçn ·∫£nh kh√°c</button>
                    <button class="btn-primary" onclick="saveTicket()">üíæ L∆∞u v√©</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const STORAGE_KEY = 'doloto_tickets';
        const OCR_API_URL = 'https://apipro2.ocr.space/parse/image';
        const OCR_API_KEY = 'copyfishonly_24';

        // ==================== STATE ====================
        const urlParams = new URLSearchParams(window.location.search);
        const ticketType = urlParams.get('type') || 'classic';

        let cells = createEmptyGrid();
        let selectedCell = null;
        let isProcessingOCR = false;

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ticket-name').value = `V√© ${getTicketCount() + 1}`;
            setupDragAndDrop();
            initTicketType();
        });

        function initTicketType() {
            const badge = document.getElementById('ticket-type-badge');
            const hint = document.getElementById('grid-hint');

            if (ticketType === '5x5') {
                badge.textContent = '‚≠ê 5x5';
                hint.textContent = 'Nh·∫•n v√†o √¥ ƒë·ªÉ nh·∫≠p s·ªë tr·ª±c ti·∫øp. H√†ng gi·ªØa c√≥ 4 s·ªë (√¥ gi·ªØa tr·ªëng).';
                document.getElementById('ocr-btn').style.display = 'none';
                document.getElementById('classic-grid-section').style.display = 'none';
                document.getElementById('5x5-grid-section').style.display = 'block';
            } else {
                badge.textContent = 'üé´ C·ªï ƒëi·ªÉn';
                hint.textContent = 'Nh·∫•n v√†o √¥ ƒë·ªÉ nh·∫≠p s·ªë tr·ª±c ti·∫øp. M·ªói h√†ng ph·∫£i c√≥ ƒë√∫ng 5 s·ªë.';
            }
        }

        function getTicketCount() {
            const tickets = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            return tickets.length;
        }

        function createEmptyGrid() {
            if (ticketType === '5x5') {
                return Array(10).fill(null).map(() => Array(5).fill(null));
            }
            return Array(9).fill(null).map(() => Array(9).fill(null));
        }

        function isCenterCell5x5(row, col) {
            return (row === 2 || row === 7) && col === 2;
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // ==================== UPLOAD ====================
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    processFile(files[0]);
                }
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processFile(file);
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('uploaded-image').src = e.target.result;
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('review-section').style.display = 'block';

                cells = createEmptyGrid();
                renderGrid();
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            cells = createEmptyGrid();
            selectedCell = null;
            document.getElementById('file-input').value = '';
            document.getElementById('upload-section').style.display = 'block';
            document.getElementById('review-section').style.display = 'none';
            document.getElementById('status-message').style.display = 'none';
            document.getElementById('quick-numbers-section').style.display = 'none';
            document.getElementById('quick-numbers-section-5x5').style.display = 'none';
        }

        // ==================== GRID RENDERING (INLINE EDITING) ====================
        function renderGrid() {
            if (ticketType === '5x5') {
                renderGrid5x5();
            } else {
                renderGridClassic();
            }
        }

        function renderGridClassic() {
            const container = document.getElementById('ticket-grid-classic');
            container.innerHTML = cells.map((row, rowIndex) => {
                const isSeparator = (rowIndex === 2 || rowIndex === 5) ? 'group-separator' : '';
                return `
                <div class="ticket-row ${isSeparator}">
                    ${row.map((cell, colIndex) => {
                        const isSelected = selectedCell && selectedCell.row === rowIndex && selectedCell.col === colIndex;
                        let cellClass = 'ticket-cell';
                        cellClass += cell === null ? ' empty' : ' number';
                        if (isSelected) cellClass += ' selected editing';

                        if (isSelected) {
                            return `<div class="${cellClass}">
                                <input type="text" class="cell-inline-input"
                                       value="${cell !== null ? cell : ''}"
                                       maxlength="2" inputmode="numeric"
                                       onblur="saveCellValue(${rowIndex}, ${colIndex})"
                                       onkeydown="handleCellKeydown(event, ${rowIndex}, ${colIndex})">
                            </div>`;
                        }

                        return `<div class="${cellClass}" onclick="selectCell(${rowIndex}, ${colIndex})">${cell !== null ? cell : ''}</div>`;
                    }).join('')}
                </div>`;
            }).join('');

            const input = container.querySelector('.cell-inline-input');
            if (input) {
                input.focus();
                input.select();
            }
        }

        function renderGrid5x5() {
            const container = document.getElementById('ticket-grid-5x5');
            container.innerHTML = cells.map((row, rowIndex) => {
                const isSeparator = rowIndex === 4 ? 'group-separator' : '';
                const isCenterRow = (rowIndex === 2 || rowIndex === 7);
                return `
                <div class="ticket-row ${isSeparator}">
                    ${row.map((cell, colIndex) => {
                        const isCenterCell = isCenterRow && colIndex === 2;
                        const isSelected = selectedCell && selectedCell.row === rowIndex && selectedCell.col === colIndex;
                        let cellClass = 'ticket-cell';

                        if (isCenterCell) {
                            cellClass += ' center-empty disabled';
                        } else if (cell === null) {
                            cellClass += ' empty';
                        } else {
                            cellClass += ' number';
                        }
                        if (isSelected && !isCenterCell) cellClass += ' selected editing';

                        if (isSelected && !isCenterCell) {
                            return `<div class="${cellClass}">
                                <input type="text" class="cell-inline-input"
                                       value="${cell !== null ? cell : ''}"
                                       maxlength="2" inputmode="numeric"
                                       onblur="saveCellValue5x5(${rowIndex}, ${colIndex})"
                                       onkeydown="handleCellKeydown5x5(event, ${rowIndex}, ${colIndex})">
                            </div>`;
                        }

                        const onclick = isCenterCell ? '' : `onclick="selectCell5x5(${rowIndex}, ${colIndex})"`;
                        return `<div class="${cellClass}" ${onclick}>${cell !== null ? cell : (isCenterCell ? '‚òÖ' : '')}</div>`;
                    }).join('')}
                </div>`;
            }).join('');

            const input = container.querySelector('.cell-inline-input');
            if (input) {
                input.focus();
                input.select();
            }
        }

        // ==================== CELL SELECTION (CLASSIC) ====================
        function selectCell(row, col) {
            if (selectedCell) {
                saveCellValue(selectedCell.row, selectedCell.col);
            }

            selectedCell = { row, col };
            renderGrid();

            const range = getColumnRange(col);
            updateQuickNumbersSection(range);
        }

        function updateQuickNumbersSection(range) {
            const section = document.getElementById('quick-numbers-section');
            section.style.display = 'block';

            const hint = section.querySelector('.helper-hint');
            if (hint) hint.textContent = `Ch·ªçn nhanh (${range.min}-${range.max}):`;

            const quickContainer = document.getElementById('quick-numbers');
            quickContainer.innerHTML = '';
            for (let num = range.min; num <= range.max; num++) {
                const btn = document.createElement('button');
                btn.className = 'quick-number-btn';
                btn.textContent = num;
                btn.onclick = () => setQuickNumber(num);
                quickContainer.appendChild(btn);
            }
        }

        function setQuickNumber(num) {
            if (!selectedCell) return;

            if (!isValidNumberForColumn(num, selectedCell.col)) {
                showStatus(`S·ªë ${num} kh√¥ng h·ª£p l·ªá cho c·ªôt n√†y`, 'error');
                return;
            }

            for (let c = 0; c < 9; c++) {
                if (cells[selectedCell.row][c] === num && c !== selectedCell.col) {
                    showStatus(`S·ªë ${num} ƒë√£ t·ªìn t·∫°i trong h√†ng`, 'error');
                    return;
                }
            }

            cells[selectedCell.row][selectedCell.col] = num;
            hideStatus();
            moveToNextCell();
        }

        function moveToNextCell() {
            if (!selectedCell) return;
            const { row, col } = selectedCell;

            if (col < 8) {
                selectCell(row, col + 1);
            } else if (row < 8) {
                selectCell(row + 1, 0);
            } else {
                selectedCell = null;
                renderGrid();
            }
        }

        function saveCellValue(row, col) {
            const container = document.getElementById('ticket-grid-classic');
            const input = container ? container.querySelector('.cell-inline-input') : null;
            if (!input) return true;

            const value = input.value.trim();

            if (value === '') {
                cells[row][col] = null;
                return true;
            }

            const number = parseInt(value);

            if (isNaN(number) || number < 1 || number > 90) {
                showStatus('S·ªë ph·∫£i t·ª´ 1-90', 'error');
                return false;
            }

            if (!isValidNumberForColumn(number, col)) {
                const range = getColumnRange(col);
                showStatus(`C·ªôt ${col + 1} ch·ªâ ch·ª©a s·ªë ${range.min}-${range.max}`, 'error');
                return false;
            }

            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (cells[r][c] === number && !(r === row && c === col)) {
                        showStatus(`S·ªë ${number} ƒë√£ t·ªìn t·∫°i trong v√©`, 'error');
                        return false;
                    }
                }
            }

            cells[row][col] = number;
            hideStatus();
            return true;
        }

        function handleCellKeydown(event, row, col) {
            const input = event.target;

            switch(event.key) {
                case 'Enter':
                    if (saveCellValue(row, col)) {
                        if (row < 8) selectCell(row + 1, col);
                        else { selectedCell = null; renderGrid(); }
                    }
                    event.preventDefault();
                    break;

                case 'Tab':
                    if (saveCellValue(row, col)) {
                        if (event.shiftKey) {
                            if (col > 0) selectCell(row, col - 1);
                            else if (row > 0) selectCell(row - 1, 8);
                        } else {
                            if (col < 8) selectCell(row, col + 1);
                            else if (row < 8) selectCell(row + 1, 0);
                        }
                    }
                    event.preventDefault();
                    break;

                case 'Escape':
                    selectedCell = null;
                    renderGrid();
                    break;

                case 'ArrowUp':
                    if (saveCellValue(row, col) && row > 0) selectCell(row - 1, col);
                    event.preventDefault();
                    break;

                case 'ArrowDown':
                    if (saveCellValue(row, col) && row < 8) selectCell(row + 1, col);
                    event.preventDefault();
                    break;

                case 'ArrowLeft':
                    if (input.selectionStart === 0 && saveCellValue(row, col) && col > 0) {
                        selectCell(row, col - 1);
                        event.preventDefault();
                    }
                    break;

                case 'ArrowRight':
                    if (input.selectionStart === input.value.length && saveCellValue(row, col) && col < 8) {
                        selectCell(row, col + 1);
                        event.preventDefault();
                    }
                    break;
            }
        }

        // ==================== CELL SELECTION (5x5) ====================
        function selectCell5x5(row, col) {
            if (isCenterCell5x5(row, col)) return;

            if (selectedCell) {
                saveCellValue5x5(selectedCell.row, selectedCell.col);
            }

            selectedCell = { row, col };
            renderGrid();
            updateQuickNumbersSection5x5();
        }

        function updateQuickNumbersSection5x5() {
            const section = document.getElementById('quick-numbers-section-5x5');
            section.style.display = 'block';

            const quickContainer = document.getElementById('quick-numbers-5x5');
            quickContainer.innerHTML = '';
            for (let num = 1; num <= 90; num++) {
                const btn = document.createElement('button');
                btn.className = 'quick-number-btn';
                btn.textContent = num;
                btn.onclick = () => setQuickNumber5x5(num);
                quickContainer.appendChild(btn);
            }
        }

        function setQuickNumber5x5(num) {
            if (!selectedCell) return;

            const board = Math.floor(selectedCell.row / 5);
            const startRow = board * 5;
            const endRow = startRow + 5;

            for (let r = startRow; r < endRow; r++) {
                for (let c = 0; c < 5; c++) {
                    if (cells[r][c] === num && !(r === selectedCell.row && c === selectedCell.col)) {
                        showStatus(`S·ªë ${num} ƒë√£ t·ªìn t·∫°i trong khung ${board + 1}`, 'error');
                        return;
                    }
                }
            }

            cells[selectedCell.row][selectedCell.col] = num;
            hideStatus();
            moveToNextCell5x5();
        }

        function moveToNextCell5x5() {
            if (!selectedCell) return;
            let { row, col } = selectedCell;

            col++;
            while (row < 10) {
                if (col > 4) {
                    col = 0;
                    row++;
                }
                if (row >= 10) break;
                if (!isCenterCell5x5(row, col)) {
                    selectCell5x5(row, col);
                    return;
                }
                col++;
            }

            selectedCell = null;
            renderGrid();
        }

        function saveCellValue5x5(row, col) {
            const container = document.getElementById('ticket-grid-5x5');
            const input = container ? container.querySelector('.cell-inline-input') : null;
            if (!input) return true;

            const value = input.value.trim();

            if (value === '') {
                cells[row][col] = null;
                return true;
            }

            const number = parseInt(value);

            if (isNaN(number) || number < 1 || number > 90) {
                showStatus('S·ªë ph·∫£i t·ª´ 1-90', 'error');
                return false;
            }

            const board = Math.floor(row / 5);
            const startRow = board * 5;
            const endRow = startRow + 5;

            for (let r = startRow; r < endRow; r++) {
                for (let c = 0; c < 5; c++) {
                    if (cells[r][c] === number && !(r === row && c === col)) {
                        showStatus(`S·ªë ${number} ƒë√£ t·ªìn t·∫°i trong khung ${board + 1}`, 'error');
                        return false;
                    }
                }
            }

            cells[row][col] = number;
            hideStatus();
            return true;
        }

        function handleCellKeydown5x5(event, row, col) {
            const input = event.target;

            switch(event.key) {
                case 'Enter':
                    if (saveCellValue5x5(row, col)) {
                        let nextRow = row + 1;
                        while (nextRow < 10 && isCenterCell5x5(nextRow, col)) nextRow++;
                        if (nextRow < 10) selectCell5x5(nextRow, col);
                        else { selectedCell = null; renderGrid(); }
                    }
                    event.preventDefault();
                    break;

                case 'Tab':
                    if (saveCellValue5x5(row, col)) {
                        moveToNextCell5x5();
                    }
                    event.preventDefault();
                    break;

                case 'Escape':
                    selectedCell = null;
                    renderGrid();
                    break;

                case 'ArrowUp':
                    if (saveCellValue5x5(row, col)) {
                        let prevRow = row - 1;
                        while (prevRow >= 0 && isCenterCell5x5(prevRow, col)) prevRow--;
                        if (prevRow >= 0) selectCell5x5(prevRow, col);
                    }
                    event.preventDefault();
                    break;

                case 'ArrowDown':
                    if (saveCellValue5x5(row, col)) {
                        let nextRow = row + 1;
                        while (nextRow < 10 && isCenterCell5x5(nextRow, col)) nextRow++;
                        if (nextRow < 10) selectCell5x5(nextRow, col);
                    }
                    event.preventDefault();
                    break;

                case 'ArrowLeft':
                    if (input.selectionStart === 0 && saveCellValue5x5(row, col)) {
                        let prevCol = col - 1;
                        while (prevCol >= 0 && isCenterCell5x5(row, prevCol)) prevCol--;
                        if (prevCol >= 0) selectCell5x5(row, prevCol);
                        event.preventDefault();
                    }
                    break;

                case 'ArrowRight':
                    if (input.selectionStart === input.value.length && saveCellValue5x5(row, col)) {
                        let nextCol = col + 1;
                        while (nextCol < 5 && isCenterCell5x5(row, nextCol)) nextCol++;
                        if (nextCol < 5) selectCell5x5(row, nextCol);
                        event.preventDefault();
                    }
                    break;
            }
        }

        // ==================== HELPER FUNCTIONS ====================
        function getColumnRange(col) {
            if (col === 0) return { min: 1, max: 9 };
            if (col === 8) return { min: 80, max: 90 };
            return { min: col * 10, max: col * 10 + 9 };
        }

        function isValidNumberForColumn(number, col) {
            const range = getColumnRange(col);
            return number >= range.min && number <= range.max;
        }

        function getColumnForNumber(number) {
            if (number >= 1 && number <= 9) return 0;
            if (number >= 80 && number <= 90) return 8;
            return Math.floor(number / 10);
        }

        // ==================== OCR (ch·ªâ cho classic) ====================
        async function runOCR() {
            if (isProcessingOCR || ticketType === '5x5') return;
            isProcessingOCR = true;

            showStatus('ƒêang nh·∫≠n di·ªán s·ªë... Vui l√≤ng ƒë·ª£i...', 'loading');

            try {
                const imageSrc = document.getElementById('uploaded-image').src;
                const formData = new FormData();
                formData.append('base64Image', imageSrc);
                formData.append('apikey', OCR_API_KEY);
                formData.append('language', 'eng');
                formData.append('isOverlayRequired', 'true');
                formData.append('detectOrientation', 'true');
                formData.append('scale', 'true');
                formData.append('OCREngine', '2');

                const response = await fetch(OCR_API_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.ParsedResults && result.ParsedResults.length > 0) {
                    const successCount = processOCRResult(result);
                    if (successCount > 0) {
                        renderGrid();
                        showStatus(`ƒê√£ t√¨m th·∫•y ${successCount} s·ªë. Vui l√≤ng ki·ªÉm tra.`, 'success');
                    } else {
                        showStatus('Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c s·ªë. Vui l√≤ng nh·∫≠p th·ªß c√¥ng.', 'warning');
                    }
                } else {
                    throw new Error(result.ErrorMessage || 'L·ªói API');
                }
            } catch (error) {
                console.error('OCR error:', error);
                showStatus('L·ªói OCR: ' + error.message, 'error');
            } finally {
                isProcessingOCR = false;
            }
        }

        function processOCRResult(ocrResult) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    cells[r][c] = null;
                }
            }

            const lines = ocrResult.ParsedResults[0].TextOverlay?.Lines;
            if (!lines || lines.length === 0) {
                const text = ocrResult.ParsedResults[0].ParsedText;
                return parseTextNumbers(text);
            }

            let allWords = [];
            lines.forEach(line => {
                line.Words.forEach(word => {
                    allWords.push({
                        text: word.WordText,
                        top: word.Top,
                        left: word.Left,
                        height: word.Height
                    });
                });
            });
            allWords.sort((a, b) => a.top - b.top);

            let rows = [];
            if (allWords.length > 0) {
                let currentRow = [allWords[0]];
                let rowThreshold = allWords[0].height / 2;

                for (let i = 1; i < allWords.length; i++) {
                    const word = allWords[i];
                    const prevWord = currentRow[currentRow.length - 1];
                    if (Math.abs(word.top - prevWord.top) < rowThreshold) {
                        currentRow.push(word);
                    } else {
                        rows.push(currentRow);
                        currentRow = [word];
                        rowThreshold = word.height / 2;
                    }
                }
                rows.push(currentRow);
            }

            let filledCount = 0;
            let targetRowIndex = 0;

            rows.forEach(rowWords => {
                if (targetRowIndex >= 9) return;

                let hasValidNumbers = false;
                rowWords.sort((a, b) => a.left - b.left);

                rowWords.forEach(word => {
                    const numbers = splitStuckNumbers(word.text);
                    numbers.forEach(num => {
                        if (num >= 1 && num <= 90) {
                            const colIndex = getColumnForNumber(num);
                            if (cells[targetRowIndex][colIndex] === null) {
                                cells[targetRowIndex][colIndex] = num;
                                filledCount++;
                                hasValidNumbers = true;
                            }
                        }
                    });
                });

                if (hasValidNumbers) {
                    targetRowIndex++;
                }
            });

            return filledCount;
        }

        function parseTextNumbers(text) {
            const numbers = [];
            const regex = /\b([1-9]|[1-8][0-9]|90)\b/g;
            let match;
            while ((match = regex.exec(text)) !== null) {
                const num = parseInt(match[1]);
                if (!numbers.includes(num)) numbers.push(num);
            }

            let filledCount = 0;
            const usedNumbers = new Set();

            for (let row = 0; row < 9 && numbers.length > 0; row++) {
                let filledInRow = 0;
                for (let i = 0; i < numbers.length && filledInRow < 5; i++) {
                    const num = numbers[i];
                    if (!usedNumbers.has(num)) {
                        const col = getColumnForNumber(num);
                        if (cells[row][col] === null) {
                            cells[row][col] = num;
                            usedNumbers.add(num);
                            filledCount++;
                            filledInRow++;
                        }
                    }
                }
            }
            return filledCount;
        }

        function splitStuckNumbers(text) {
            text = text.replace(/[^0-9]/g, '');
            if (!text) return [];

            if (text.length <= 2) {
                const val = parseInt(text);
                return (val >= 1 && val <= 90) ? [val] : [];
            }

            const result = [];
            let i = 0;

            while (i < text.length) {
                if (i + 2 <= text.length) {
                    const twoChar = text.substring(i, i + 2);
                    const val2 = parseInt(twoChar);

                    if (val2 >= 1 && val2 <= 90) {
                        const nextChar = text[i + 2];
                        if (nextChar === '0') {
                            const oneChar = text.substring(i, i + 1);
                            result.push(parseInt(oneChar));
                            i += 1;
                        } else {
                            result.push(val2);
                            i += 2;
                        }
                    } else {
                        const oneChar = text.substring(i, i + 1);
                        result.push(parseInt(oneChar));
                        i += 1;
                    }
                } else {
                    const oneChar = text.substring(i, i + 1);
                    result.push(parseInt(oneChar));
                    i += 1;
                }
            }

            return result;
        }

        // ==================== SAVE ====================
        function saveTicket() {
            const name = document.getElementById('ticket-name').value.trim();
            if (!name) {
                showStatus('Vui l√≤ng nh·∫≠p t√™n v√©', 'error');
                return;
            }

            let validation;
            if (ticketType === '5x5') {
                validation = validateTicket5x5();
            } else {
                validation = validateTicketClassic();
            }

            if (!validation.valid) {
                showStatus(validation.error, 'error');
                return;
            }

            const ticket = {
                id: Date.now(),
                name: name,
                ticketType: ticketType,
                cells: JSON.parse(JSON.stringify(cells)),
                type: 'upload',
                createdAt: new Date().toISOString()
            };

            const tickets = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            tickets.push(ticket);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));

            window.location.href = 'index.html';
        }

        function validateTicketClassic() {
            for (let row = 0; row < 9; row++) {
                const numbersInRow = cells[row].filter(n => n !== null);
                if (numbersInRow.length !== 5) {
                    return { valid: false, error: `H√†ng ${row + 1} ph·∫£i c√≥ ƒë√∫ng 5 s·ªë (hi·ªán c√≥ ${numbersInRow.length})` };
                }
            }
            return { valid: true };
        }

        function validateTicket5x5() {
            for (let board = 0; board < 2; board++) {
                const boardNumbers = new Set();
                const startRow = board * 5;

                for (let localRow = 0; localRow < 5; localRow++) {
                    const row = startRow + localRow;
                    const isCenterRow = localRow === 2;

                    const numbersInRow = cells[row].filter((n, col) => {
                        if (isCenterRow && col === 2) return false;
                        return n !== null;
                    });

                    const expectedCount = isCenterRow ? 4 : 5;
                    if (numbersInRow.length !== expectedCount) {
                        return { valid: false, error: `H√†ng ${row + 1} ph·∫£i c√≥ ${expectedCount} s·ªë (hi·ªán c√≥ ${numbersInRow.length})` };
                    }

                    for (const num of numbersInRow) {
                        if (num < 1 || num > 90) {
                            return { valid: false, error: `S·ªë ${num} kh√¥ng h·ª£p l·ªá (1-90)` };
                        }
                        if (boardNumbers.has(num)) {
                            return { valid: false, error: `S·ªë ${num} b·ªã tr√πng trong khung ${board + 1}` };
                        }
                        boardNumbers.add(num);
                    }
                }
            }
            return { valid: true };
        }

        // ==================== UI ====================
        function showStatus(message, type) {
            const el = document.getElementById('status-message');
            el.textContent = message;
            el.style.display = 'block';

            switch(type) {
                case 'success':
                    el.style.background = 'rgba(76,175,80,0.2)';
                    el.style.color = '#155724';
                    break;
                case 'error':
                    el.style.background = 'rgba(244,67,54,0.2)';
                    el.style.color = '#721c24';
                    break;
                case 'warning':
                case 'loading':
                    el.style.background = 'rgba(255,193,7,0.2)';
                    el.style.color = '#856404';
                    break;
            }
        }

        function hideStatus() {
            document.getElementById('status-message').style.display = 'none';
        }

        // ==================== BULK INPUT ====================
        function toggleBulkInput() {
            const container = document.getElementById('bulk-input-container');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        function clearBulkInput() {
            document.getElementById('bulk-input-text').value = '';
        }

        function applyBulkInput() {
            const text = document.getElementById('bulk-input-text').value.trim();
            if (!text) {
                showStatus('Vui l√≤ng nh·∫≠p s·ªë', 'error');
                return;
            }

            const lines = text.split('\n').filter(line => line.trim());

            if (ticketType === '5x5') {
                applyBulkInput5x5(lines);
            } else {
                applyBulkInputClassic(lines);
            }
        }

        function parseNumbersFromLine(line) {
            return line
                .split(/[\s,;]+/)
                .map(s => s.trim())
                .filter(s => s)
                .map(s => parseInt(s))
                .filter(n => !isNaN(n) && n >= 1 && n <= 90);
        }

        function applyBulkInputClassic(lines) {
            const maxRows = 9;
            const newCells = Array(9).fill(null).map(() => Array(9).fill(null));

            for (let rowIndex = 0; rowIndex < Math.min(lines.length, maxRows); rowIndex++) {
                const numbers = parseNumbersFromLine(lines[rowIndex]);

                if (numbers.length > 5) {
                    showStatus(`D√≤ng ${rowIndex + 1}: T·ªëi ƒëa 5 s·ªë m·ªói h√†ng`, 'error');
                    return;
                }

                for (const num of numbers) {
                    const col = getColumnForNumber(num);

                    if (newCells[rowIndex][col] !== null) {
                        showStatus(`D√≤ng ${rowIndex + 1}: S·ªë ${num} v√† ${newCells[rowIndex][col]} c√πng c·ªôt`, 'error');
                        return;
                    }

                    for (let r = 0; r < maxRows; r++) {
                        for (let c = 0; c < 9; c++) {
                            if (newCells[r][c] === num) {
                                showStatus(`S·ªë ${num} b·ªã tr√πng`, 'error');
                                return;
                            }
                        }
                    }

                    newCells[rowIndex][col] = num;
                }
            }

            cells = newCells;
            selectedCell = null;
            renderGrid();
            hideStatus();
            document.getElementById('bulk-input-container').style.display = 'none';

            if (lines.length < maxRows) {
                showStatus(`ƒê√£ nh·∫≠p ${lines.length}/${maxRows} h√†ng`, 'warning');
            }
        }

        function applyBulkInput5x5(lines) {
            const maxRows = 10;
            const newCells = Array(10).fill(null).map(() => Array(5).fill(null));

            for (let rowIndex = 0; rowIndex < Math.min(lines.length, maxRows); rowIndex++) {
                const numbers = parseNumbersFromLine(lines[rowIndex]);
                const isCenterRow = (rowIndex === 2 || rowIndex === 7);
                const expectedCount = isCenterRow ? 4 : 5;

                if (numbers.length > expectedCount) {
                    showStatus(`D√≤ng ${rowIndex + 1}: T·ªëi ƒëa ${expectedCount} s·ªë`, 'error');
                    return;
                }

                const board = Math.floor(rowIndex / 5);
                const boardStart = board * 5;
                const boardEnd = boardStart + 5;

                let colIndex = 0;
                for (const num of numbers) {
                    if (isCenterRow && colIndex === 2) colIndex++;
                    if (colIndex >= 5) break;

                    for (let r = boardStart; r < boardEnd; r++) {
                        for (let c = 0; c < 5; c++) {
                            if (newCells[r][c] === num) {
                                showStatus(`S·ªë ${num} b·ªã tr√πng trong khung ${board + 1}`, 'error');
                                return;
                            }
                        }
                    }

                    newCells[rowIndex][colIndex] = num;
                    colIndex++;
                }
            }

            cells = newCells;
            selectedCell = null;
            renderGrid();
            hideStatus();
            document.getElementById('bulk-input-container').style.display = 'none';

            if (lines.length < maxRows) {
                showStatus(`ƒê√£ nh·∫≠p ${lines.length}/${maxRows} h√†ng`, 'warning');
            }
        }
    </script>
</body>
</html>
